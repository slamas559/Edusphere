{% load static %}
{% load date_filters %}

<div class="comment-container group" data-id="{{ comment.id }}">
  <div class="flex items-start gap-3 p-3 hover:bg-gray-50 dark:hover:bg-gray-800/50 rounded-lg transition-colors">
    <!-- Profile Picture -->
    <a href="{% url 'profile' comment.user.profile.slug %}" class="flex-shrink-0">
      {% if not comment.user.profile.profile_picture %}
          <div class="h-10 w-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white font-medium">
              {{ comment.user.username.0|upper }}
          </div>
      {% else %}
          <img class="h-10 w-10 border-2 border-gray-300 dark:border-gray-600 rounded-full object-cover"
              src="{{ comment.user.profile.profile_picture.url }}" alt="{{ comment.user.username }} profile picture">
      {% endif %}
    </a>

    <!-- Comment Content -->
    <div class="flex-1 min-w-0 space-y-1">
      <div class="flex items-center justify-between gap-2 mb-1">
        <!-- Username -->
        <a href="{% url 'profile' comment.user.profile.slug %}" 
           class="font-medium text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 transition-colors truncate">
          {{ comment.user.username }}
        </a>
        
        <!-- Timestamp -->
        <span class="text-xs text-gray-500 dark:text-gray-400 whitespace-nowrap">
          {% if comment.created_at|seconds > 604800 %}
            {{ comment.created_at|date:"M j, Y" }}
          {% else %}
            {{ comment.created_at|timesince }} ago
          {% endif %}
        </span>
      </div>

      <!-- Comment Text -->
      <div class="prose dark:prose-invert max-w-none">
        <p class="text-gray-700 dark:text-gray-300">{{ comment.content }}</p>
      </div>

      <!-- Actions -->
      <div class="flex items-center gap-3 mt-2">
        <!-- Reply Button -->
        <button class="reply-btn text-xs font-medium text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
                data-id="{{ comment.id }}" 
                user-name="{{ comment.user.username }}">
          Reply
        </button>

        <!-- View Replies Toggle -->
        {% if comment.replies.all %}
          <button class="show-btn flex items-center gap-1 text-xs font-medium text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
                  data-id="{{ comment.id }}">
            <span>{{ comment.replies.count }} repl{{ comment.replies.count|pluralize:"y,ies" }}</span>
            <svg class="arrow w-3 h-3 transform transition-transform duration-200" 
                 viewBox="0 0 20 20" 
                 fill="currentColor">
              <path fill-rule="evenodd" 
                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" 
                    clip-rule="evenodd" />
            </svg>
          </button>
        {% endif %}
      </div>

      <!-- Replies Container -->
      <div class="replies ml-3 mt-3 border-l-2 border-gray-200 dark:border-gray-700 pl-3 hidden space-y-3">
        {% for reply in comment.replies.all %}
          {% include 'blog/partials/comment.html' with comment=reply %}
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Reply button functionality
  document.querySelectorAll('.reply-btn').forEach(button => {
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      const parentId = button.getAttribute('data-id');
      const userName = button.getAttribute('user-name');
      
      // Set up reply in the form
      document.getElementById('parent_id').value = parentId;
      const commentBox = document.getElementById('comment_box');
      commentBox.placeholder = `Replying to @${userName}...`;
      commentBox.focus();
      
      // Smooth scroll to comment form if needed
      const form = document.querySelector('form');
      form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    });
  });

  // Show/hide replies functionality
  document.querySelectorAll('.show-btn').forEach(button => {
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      const commentContainer = button.closest('.comment-container');
      const replies = commentContainer.querySelector('.replies');
      const arrow = button.querySelector('.arrow');
      
      // Toggle visibility
      replies.classList.toggle('hidden');
      
      // Rotate arrow
      arrow.classList.toggle('rotate-180');
      
      // Update button text
      const replyCount = parseInt(button.querySelector('span').textContent);
      if (replies.classList.contains('hidden')) {
        button.querySelector('span').textContent = `${replyCount} repl${replyCount !== 1 ? 'ies' : 'y'}`;
      } else {
        button.querySelector('span').textContent = `Hide repl${replyCount !== 1 ? 'ies' : 'y'}`;
      }
    });
  });
});
</script>